<?php

namespace App\Providers;

use Illuminate\Support\ServiceProvider;
use Illuminate\Support\Facades\{Gate, Blade, Auth, URL}; // Ajout de URL ici
use App\Auth\PatientUserProvider;
use App\Models\Patient;

class AppServiceProvider extends ServiceProvider
{
    public function register(): void
    {
        //
    }

    public function boot(): void
    {
        // FORCE LE HTTPS SUR RAILWAY
        if (config('app.env') === 'production') {
            URL::forceScheme('https');
        }

        // Enregistrer le provider personnalisé pour patients
        Auth::provider('patient', function ($app, array $config) {
            return new PatientUserProvider($app['hash'], Patient::class);
        });

        // Directives Blade personnalisées
        Blade::directive('role', function ($role) {
            return "<?php if(auth()->check() && auth()->user()->role === {$role}): ?>";
        });

        Blade::directive('endrole', function () {
            return '<?php endif; ?>';
        });

        // Gates pour les permissions
        Gate::define('view-patient', function ($user, $patientId) {
            if ($user->isAdmin()) {
                return true;
            }

            if ($user->isDoctor() || $user->isNurse()) {
                $patient = Patient::find($patientId);
                return $patient && $patient->admissions()
                    ->where('status', 'active')
                    ->whereHas('room', function($q) use ($user) {
                        $q->where('service_id', $user->service_id);
                    })
                    ->exists();
            }

            return false;
        });

        Gate::define('prescribe', function ($user) {
            return $user->isDoctor();
        });

        Gate::define('validate-document', function ($user) {
            return $user->isDoctor();
        });
    }
}